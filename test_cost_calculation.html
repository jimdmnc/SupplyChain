<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Total Production Cost Analysis for Existing Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .cost-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .cost-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .form-section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Test - Total Production Cost Analysis for Existing Products</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Complete Production Modal Simulation</h5>
                    </div>
                    <div class="card-body">
                        <form id="testForm">
                            <div class="mb-3">
                                <label for="productionType" class="form-label">Production Type</label>
                                <select class="form-select" id="productionType">
                                    <option value="new-product">New Product</option>
                                    <option value="existing-batch" selected>Another Batch (Existing Product)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="productSelect" class="form-label">Select Existing Product</label>
                                <select class="form-select" id="productSelect">
                                    <option value="">-- Select Product --</option>
                                    <option value="P029">P029 - Piña Bars (₱130.00)</option>
                                    <option value="P030">P030 - Piña Putoseko (₱50.00)</option>
                                    <option value="P031">P031 - Piña Tuyo (₱180.00)</option>
                                    <option value="P033">P033 - Pineapple Concentrate (₱130.00)</option>
                                    <option value="P034">P034 - Piña Dishwashing Soap (₱60.00)</option>
                                    <option value="P035">P035 - Piña Mangga Bars (₱130.00)</option>
                                    <option value="P036">P036 - Piña Tsokolate Bars (₱130.00)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="quantityProduced" class="form-label">Quantity Produced</label>
                                <input type="number" class="form-control" id="quantityProduced" value="100" min="1">
                            </div>
                            
                            <div class="mb-3">
                                <label for="materialCost" class="form-label">Material Costs (₱)</label>
                                <input type="number" class="form-control" id="materialCost" value="5000" min="0" step="0.01">
                            </div>
                            
                            <div class="mb-3">
                                <label for="operationalCost" class="form-label">Operational Costs (₱)</label>
                                <input type="number" class="form-control" id="operationalCost" value="2000" min="0" step="0.01">
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="calculateCosts()">
                                Calculate Total Production Cost Analysis
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Total Production Cost Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="bi bi-currency-dollar"></i>
                                Total Production Cost Analysis
                            </div>
                            <div class="cost-summary">
                                <div class="cost-item">
                                    <span>Material Costs:</span>
                                    <span id="final-material-cost">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Operational Costs:</span>
                                    <span id="final-operational-cost">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Total Production Cost:</span>
                                    <span id="total-production-cost">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Cost per Unit:</span>
                                    <span id="final-cost-per-unit">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Revenue per Unit:</span>
                                    <span id="revenue-per-unit">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Profit per Unit:</span>
                                    <span id="profit-per-unit">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Total Revenue:</span>
                                    <span id="total-revenue">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Total Profit:</span>
                                    <span id="total-profit">₱0.00</span>
                                </div>
                                <div class="cost-item">
                                    <span>Profit Margin:</span>
                                    <span id="profit-margin">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Implementation Details</h5>
                    </div>
                    <div class="card-body">
                        <h6>Enhanced Features:</h6>
                        <ul>
                            <li><strong>Database Integration:</strong> Fetches existing product prices from the products table</li>
                            <li><strong>Complete Production Modal:</strong> Works specifically in the Complete Production modal for "Another Batch" type productions</li>
                            <li><strong>Real-time Calculations:</strong> Updates cost analysis when product is selected or quantity changes</li>
                            <li><strong>Fallback Mechanism:</strong> Uses loaded products first, then fetches from database if needed</li>
                            <li><strong>Comprehensive Analysis:</strong> Shows material costs, operational costs, revenue, profit, and profit margin</li>
                        </ul>
                        
                        <h6>Key Functions Enhanced:</h6>
                        <ul>
                            <li><code>updateProfitCalculations()</code> - Main calculation function with database integration</li>
                            <li><code>fetchExistingProductPrice()</code> - Fetches product price from database</li>
                            <li><code>calculateExistingProductRevenue()</code> - Calculates revenue for existing products</li>
                            <li><code>openCompleteProductionModal()</code> - Triggers calculations when modal opens</li>
                        </ul>
                        
                        <h6>Database Structure Used:</h6>
                        <pre><code>products table:
- id
- product_id (e.g., P029, P030, etc.)
- product_name
- price (decimal(10,2))
- category
- stocks
- batch_tracking
- status
- created_at
- updated_at</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simulate the enhanced functions from production.js
        let selectedProductionType = "existing-batch";
        let totalMaterialCost = 0;
        let totalOperationalCost = 0;
        let totalProductionCost = 0;
        let totalRevenue = 0;
        let totalProfit = 0;
        
        // Mock product data (in real implementation, this comes from database)
        const mockProducts = {
            'P029': { product_id: 'P029', name: 'Piña Bars', price: 130.00 },
            'P030': { product_id: 'P030', name: 'Piña Putoseko', price: 50.00 },
            'P031': { product_id: 'P031', name: 'Piña Tuyo', price: 180.00 },
            'P033': { product_id: 'P033', name: 'Pineapple Concentrate', price: 130.00 },
            'P034': { product_id: 'P034', name: 'Piña Dishwashing Soap', price: 60.00 },
            'P035': { product_id: 'P035', name: 'Piña Mangga Bars', price: 130.00 },
            'P036': { product_id: 'P036', name: 'Piña Tsokolate Bars', price: 130.00 }
        };

        function calculateCosts() {
            const productId = document.getElementById('productSelect').value;
            const quantity = parseInt(document.getElementById('quantityProduced').value) || 0;
            const materialCost = parseFloat(document.getElementById('materialCost').value) || 0;
            const operationalCost = parseFloat(document.getElementById('operationalCost').value) || 0;
            
            // Get product price from mock data (simulates database fetch)
            const product = mockProducts[productId];
            const price = product ? product.price : 0;
            
            // Calculate costs
            totalMaterialCost = materialCost;
            totalOperationalCost = operationalCost;
            totalProductionCost = materialCost + operationalCost;
            
            // Calculate revenue and profit
            totalRevenue = quantity * price;
            totalProfit = totalRevenue - totalProductionCost;
            
            // Calculate per-unit values
            const costPerUnit = quantity > 0 ? totalProductionCost / quantity : 0;
            const profitPerUnit = price - costPerUnit;
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            
            // Update display
            document.getElementById('final-material-cost').textContent = `₱${totalMaterialCost.toFixed(2)}`;
            document.getElementById('final-operational-cost').textContent = `₱${totalOperationalCost.toFixed(2)}`;
            document.getElementById('total-production-cost').textContent = `₱${totalProductionCost.toFixed(2)}`;
            document.getElementById('final-cost-per-unit').textContent = `₱${costPerUnit.toFixed(2)}`;
            document.getElementById('revenue-per-unit').textContent = `₱${price.toFixed(2)}`;
            document.getElementById('profit-per-unit').textContent = `₱${profitPerUnit.toFixed(2)}`;
            document.getElementById('total-revenue').textContent = `₱${totalRevenue.toFixed(2)}`;
            document.getElementById('total-profit').textContent = `₱${totalProfit.toFixed(2)}`;
            document.getElementById('profit-margin').textContent = `${profitMargin.toFixed(1)}%`;
            
            console.log('Cost Analysis Results:', {
                productId,
                productName: product ? product.name : 'N/A',
                quantity,
                price,
                materialCost,
                operationalCost,
                totalProductionCost,
                totalRevenue,
                totalProfit,
                profitMargin
            });
        }
        
        // Add event listeners for real-time updates
        document.getElementById('productSelect').addEventListener('change', calculateCosts);
        document.getElementById('quantityProduced').addEventListener('input', calculateCosts);
        document.getElementById('materialCost').addEventListener('input', calculateCosts);
        document.getElementById('operationalCost').addEventListener('input', calculateCosts);
        
        // Initialize with default values
        calculateCosts();
    </script>
</body>
</html> 